{
  "$schema": "https://raw.githubusercontent.com/martinring/tmlanguage/master/tmlanguage.json",
  "name": "Modality",
  "patterns": [
    { "include": "#comment" },
    { "include": "#model" },
    { "include": "#formula" },
    { "include": "#rule" },
    { "include": "#action" },
    { "include": "#test" },
    { "include": "#contract" }
  ],
  "repository": {
    "comment": {
      "patterns": [
        {
          "name": "comment.line.double-slash.modality",
          "match": "//.*$"
        },
        {
          "name": "comment.block.modality",
          "begin": "/\\*",
          "end": "\\*/"
        }
      ]
    },
    "model": {
      "patterns": [
        {
          "begin": "\\b(export\\s+default\\s+)?(model)\\s+([a-zA-Z_][a-zA-Z0-9_]*)\\s*\\{",
          "end": "\\}",
          "beginCaptures": {
            "1": { "name": "keyword.control.export.modality" },
            "2": { "name": "keyword.declaration.model.modality" },
            "3": { "name": "entity.name.type.model.modality" }
          },
          "patterns": [
            { "include": "#comment" },
            { "include": "#initial" },
            { "include": "#part" },
            { "include": "#transition" }
          ]
        },
        {
          "begin": "\\b(export\\s+default\\s+)?(model)\\s*\\{",
          "end": "\\}",
          "beginCaptures": {
            "1": { "name": "keyword.control.export.modality" },
            "2": { "name": "keyword.declaration.model.modality" }
          },
          "patterns": [
            { "include": "#comment" },
            { "include": "#initial" },
            { "include": "#part" },
            { "include": "#transition" }
          ]
        }
      ]
    },
    "initial": {
      "match": "\\b(initial)\\s+([a-zA-Z_][a-zA-Z0-9_]*)",
      "captures": {
        "1": { "name": "keyword.control.initial.modality" },
        "2": { "name": "entity.name.tag.state.modality" }
      }
    },
    "part": {
      "begin": "\\b(part)\\s+([a-zA-Z_][a-zA-Z0-9_]*)\\s*\\{",
      "end": "\\}",
      "beginCaptures": {
        "1": { "name": "keyword.declaration.part.modality" },
        "2": { "name": "entity.name.type.part.modality" }
      },
      "patterns": [
        { "include": "#comment" },
        { "include": "#transition" }
      ]
    },
    "transition": {
      "patterns": [
        {
          "match": "([a-zA-Z_][a-zA-Z0-9_]*)\\s*(->|-->)\\s*([a-zA-Z_][a-zA-Z0-9_]*)\\s*(?:\\[([^\\]]*)\\])?",
          "captures": {
            "1": { "name": "entity.name.tag.state.from.modality" },
            "2": { "name": "keyword.operator.arrow.modality" },
            "3": { "name": "entity.name.tag.state.to.modality" },
            "4": { "patterns": [{ "include": "#properties" }] }
          }
        },
        {
          "match": "([a-zA-Z_][a-zA-Z0-9_]*)\\s*(->|-->)\\s*([a-zA-Z_][a-zA-Z0-9_]*)\\s*:\\s*(.*)$",
          "captures": {
            "1": { "name": "entity.name.tag.state.from.modality" },
            "2": { "name": "keyword.operator.arrow.modality" },
            "3": { "name": "entity.name.tag.state.to.modality" },
            "4": { "patterns": [{ "include": "#properties" }] }
          }
        }
      ]
    },
    "properties": {
      "patterns": [
        {
          "match": "(\\+|-)([a-zA-Z_][a-zA-Z0-9_]*)\\s*\\(([^)]+)\\)",
          "captures": {
            "1": { "name": "keyword.operator.sign.modality" },
            "2": { "name": "entity.name.function.predicate.modality" },
            "3": { "name": "variable.parameter.modality" }
          }
        },
        {
          "match": "(\\+|-)([a-zA-Z_][a-zA-Z0-9_]*)",
          "captures": {
            "1": { "name": "keyword.operator.sign.modality" },
            "2": { "name": "constant.other.property.modality" }
          }
        }
      ]
    },
    "formula": {
      "patterns": [
        {
          "begin": "\\b(formula)\\s+([a-zA-Z_][a-zA-Z0-9_]*)\\s*\\{",
          "end": "\\}",
          "beginCaptures": {
            "1": { "name": "keyword.declaration.formula.modality" },
            "2": { "name": "entity.name.function.formula.modality" }
          },
          "patterns": [
            { "include": "#comment" },
            { "include": "#formula_expr" }
          ]
        }
      ]
    },
    "rule": {
      "patterns": [
        {
          "begin": "\\b(export\\s+default\\s+)?(rule)\\s*\\{",
          "end": "\\}",
          "beginCaptures": {
            "1": { "name": "keyword.control.export.modality" },
            "2": { "name": "keyword.declaration.rule.modality" }
          },
          "patterns": [
            { "include": "#comment" },
            { "include": "#starting_at" },
            { "include": "#formula_block" }
          ]
        }
      ]
    },
    "starting_at": {
      "match": "\\b(starting_at|starting_since)\\s+(\\$[A-Z_]+|[a-zA-Z0-9_]+)",
      "captures": {
        "1": { "name": "keyword.control.starting.modality" },
        "2": { "name": "variable.other.constant.modality" }
      }
    },
    "formula_block": {
      "begin": "\\b(formula)\\s*\\{",
      "end": "\\}",
      "beginCaptures": {
        "1": { "name": "keyword.declaration.formula.modality" }
      },
      "patterns": [
        { "include": "#comment" },
        { "include": "#formula_expr" }
      ]
    },
    "formula_expr": {
      "patterns": [
        { "include": "#comment" },
        { "include": "#temporal_operators" },
        { "include": "#fixed_point_operators" },
        { "include": "#modal_operators" },
        { "include": "#boolean_operators" },
        { "include": "#predicates" },
        { "include": "#literals" },
        { "include": "#variables" }
      ]
    },
    "temporal_operators": {
      "patterns": [
        {
          "match": "\\b(always|eventually|next)\\b",
          "name": "keyword.operator.temporal.modality"
        },
        {
          "match": "\\b(until)\\b",
          "name": "keyword.operator.temporal.until.modality"
        },
        {
          "match": "[□◇]",
          "name": "keyword.operator.temporal.unicode.modality"
        }
      ]
    },
    "fixed_point_operators": {
      "patterns": [
        {
          "match": "\\b(lfp|gfp)\\s*\\(\\s*([A-Z][a-zA-Z0-9_]*)\\s*,",
          "captures": {
            "1": { "name": "keyword.operator.fixedpoint.modality" },
            "2": { "name": "variable.other.fixedpoint.modality" }
          }
        },
        {
          "match": "[μν]\\s*([A-Z][a-zA-Z0-9_]*)\\s*\\.",
          "captures": {
            "0": { "name": "keyword.operator.fixedpoint.unicode.modality" },
            "1": { "name": "variable.other.fixedpoint.modality" }
          }
        }
      ]
    },
    "modal_operators": {
      "patterns": [
        {
          "match": "\\[\\s*<([^>]*)>\\s*\\]",
          "captures": {
            "0": { "name": "keyword.operator.modal.diamondbox.modality" },
            "1": { "patterns": [{ "include": "#properties" }] }
          }
        },
        {
          "match": "<([^>]*)>",
          "captures": {
            "0": { "name": "keyword.operator.modal.diamond.modality" },
            "1": { "patterns": [{ "include": "#properties" }] }
          }
        },
        {
          "match": "\\[([^\\]]*)\\]",
          "captures": {
            "0": { "name": "keyword.operator.modal.box.modality" },
            "1": { "patterns": [{ "include": "#properties" }] }
          }
        }
      ]
    },
    "boolean_operators": {
      "patterns": [
        {
          "match": "\\b(and|or|not|implies)\\b",
          "name": "keyword.operator.logical.modality"
        },
        {
          "match": "(&|\\||!|->)",
          "name": "keyword.operator.logical.symbol.modality"
        }
      ]
    },
    "predicates": {
      "patterns": [
        {
          "match": "\\b(signed_by|exists|post_to|include_sig)\\s*\\(",
          "captures": {
            "1": { "name": "entity.name.function.predicate.modality" }
          }
        }
      ]
    },
    "literals": {
      "patterns": [
        {
          "match": "\\b(true|false)\\b",
          "name": "constant.language.boolean.modality"
        }
      ]
    },
    "variables": {
      "patterns": [
        {
          "match": "\\b([A-Z][a-zA-Z0-9_]*)\\b",
          "name": "variable.other.modality"
        },
        {
          "match": "/[a-zA-Z0-9_/\\.]+",
          "name": "string.other.path.modality"
        }
      ]
    },
    "action": {
      "begin": "\\b(action)\\s+([a-zA-Z_][a-zA-Z0-9_]*)\\s*\\{",
      "end": "\\}",
      "beginCaptures": {
        "1": { "name": "keyword.declaration.action.modality" },
        "2": { "name": "entity.name.function.action.modality" }
      },
      "patterns": [
        { "include": "#comment" },
        { "include": "#properties" }
      ]
    },
    "test": {
      "begin": "\\b(test)\\s*([a-zA-Z_][a-zA-Z0-9_]*)?\\s*\\{",
      "end": "\\}",
      "beginCaptures": {
        "1": { "name": "keyword.declaration.test.modality" },
        "2": { "name": "entity.name.function.test.modality" }
      },
      "patterns": [
        { "include": "#comment" },
        { "include": "#test_statements" }
      ]
    },
    "test_statements": {
      "patterns": [
        {
          "match": "\\b(assert|clone|commit)\\b",
          "name": "keyword.control.test.modality"
        }
      ]
    },
    "contract": {
      "begin": "\\b(contract)\\s+([a-zA-Z_][a-zA-Z0-9_]*)\\s*\\{",
      "end": "\\}",
      "beginCaptures": {
        "1": { "name": "keyword.declaration.contract.modality" },
        "2": { "name": "entity.name.type.contract.modality" }
      },
      "patterns": [
        { "include": "#comment" },
        { "include": "#commit" }
      ]
    },
    "commit": {
      "begin": "\\b(commit)\\s*\\{",
      "end": "\\}",
      "beginCaptures": {
        "1": { "name": "keyword.declaration.commit.modality" }
      },
      "patterns": [
        { "include": "#comment" },
        { "include": "#commit_statements" }
      ]
    },
    "commit_statements": {
      "patterns": [
        {
          "match": "\\b(signed_by)\\s+([a-zA-Z_][a-zA-Z0-9_]*)\\s+(\"[^\"]*\")",
          "captures": {
            "1": { "name": "keyword.other.signed_by.modality" },
            "2": { "name": "entity.name.tag.party.modality" },
            "3": { "name": "string.quoted.double.signature.modality" }
          }
        },
        {
          "match": "\\b(add_rule|do)\\b",
          "name": "keyword.control.commit.modality"
        },
        { "include": "#properties" },
        { "include": "#formula_expr" }
      ]
    },
    "strings": {
      "name": "string.quoted.double.modality",
      "begin": "\"",
      "end": "\"",
      "patterns": [
        {
          "name": "constant.character.escape.modality",
          "match": "\\\\."
        }
      ]
    }
  },
  "scopeName": "source.modality"
}
